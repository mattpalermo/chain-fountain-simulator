<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chain fountain simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background-size: 20px 20px;
      background-image:
        linear-gradient(to right, lavender 1px, transparent 1px),
        linear-gradient(to bottom, lavender 1px, transparent 1px);
      font-family: Verdana, Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
    }

    #header {
      box-sizing: border-box;
      width: 100%;
      height: 2em;
      padding: 0.3em 0.5em;
      margin: 0;
      display: flex;
      align-items: center;
      background-color: linen;
      box-shadow: 0px 0px 5px black;
    }

    #simulation-canvas {
      box-sizing: border-box;
      width: 100%;
      height: calc(100vh - 4em);
      margin: 0;
      padding: 0;
      display: block;
    }

    #parameters {
      position: absolute;
      top: 3em;
      right: 1em;
      box-sizing: border-box;
      width: 20em;
      max-width: calc(100vw - 2em);
      max-height: 100vh;
      overflow: auto;
      background-color: white;
      box-shadow: 2px 2px 5px black;
      padding: 0.5em;
    }
    #parameters .header {
      margin-bottom: 0.3em;
      display: flex;
      align-items: center;
    }
    #parameters h2 { margin-left: 0.5em }
    #parameters .header button {
      width: 2em;
      height: 2em;
      padding: 0;
      margin: 0;
    }
    #parameters label {
      display: block;
      text-align: right;
      margin: 0.2em 0;
    }
    #parameters input { width: 8ch }
    #parameters em {
      font-size: small;
      margin-top: 1em;
      display: block
    }

    #controls {
      box-sizing: border-box;
      overflow: auto;
      width: 100%;
      height: 2em;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      background-color: linen;
      box-shadow: 0px 0px 2px black;
    }
    #controls > * {margin-left: 0.5em; margin-right: 0.5em}
    #controls label {margin-right: auto }
    #controls input { width: 5ch }

    h1 {
      margin: 0;
      margin-right: auto;
      padding: 0;
      font-size: 1.3em;
      font-weight: normal;
    }
    h2 {
      font-size: 1.2em;
      font-weight: normal;
      margin: 0;
      padding: 0;
    }

    @media (max-width: 25em) {
      #header .extra-content { display: none }
    }
    @media (max-width: 35em) {
      #controls .extra-content { display: none }
    }

  </style>
</head>
<body>
  <div id="header">
    <h1>Chain fountain simulator</h1>
    <a href="https://github.com/mattpalermo/chain-fountain-simulator">
      (?) <span class="extra-content">About</span>
    </a>
  </div>

  <div id="parameters" style="visibility:hidden">
    <div class="header">
      <button id="close-parameters" onclick="closeParameters()">‚ùå</button>
      <h2>Parameters</h2>
    </div>
    <label>Bead mass (g):
      <input id="bead-mass" type="number" value="5" step="any">
    </label>
    <label>Link length (mm):
      <input id="link-length" type="number" value="5" step="any">
    </label>
    <label>Initial height (m):
      <input id="initial-height" type="number" value="1" step="any">
    </label>
    <label>Integration time step (ms):
      <input id="time-step" type="number" value="10" step="any">
    </label>
    <em>Note: changing parameters resets the integration</em>
  </div>

  <canvas id="simulation-canvas"></canvas>

  <div id="controls">
    <button id="toggle-play" onclick="togglePlay()">‚ñ∂Ô∏è</button>
    <label>Time (s):
      <input id="time" type="number" value="0" step="any">
    </label>
    <button id="toggle-parameters" onclick="toggleParameters()">
      ‚öô <span class="extra-content">Parameters</span>
    </button>
    <a id="export" href="" download="mould-integration.json">
      üíæ <span class="extra-content">Export integration data</span>
    </a>
  </div>

  <script>
    // UI elements
    let elParameters = document.getElementById("parameters");
    let elTogglePlay = document.getElementById("toggle-play");
    let elTime = document.getElementById("time");
    let elBeadMass = document.getElementById("bead-mass");
    let elLinkLength = document.getElementById("link-length");
    let elInitialHeight = document.getElementById("initial-height");
    let elTimeStep = document.getElementById("time-step");
    let elCanvas = document.getElementById("simulation-canvas");
    let ctx = elCanvas.getContext("2d");

    // Constants
    let platformWidth = 0.1;
    let platformHeight = 0.02;
    let platformColour = "#000000";
    let beadRadius = 0.01;
    let beadColour = "#FF0000";
    let linkColour = "#0000FF";

    // Global variables
    let currentIntegration;
    let lastFrameTime;
    let curAnimationTime = 0; // This time might not coincide with an integration step.
    let animationPlaying = false;
    let playStartTime;

    // When the toggle parameters UI button is clicked
    function toggleParameters() {
      if(elParameters.style.visibility === "hidden") {
        elParameters.style.visibility = "visible";
      } else {
        elParameters.style.visibility = "hidden";
      }
    }

    // When the close parameters UI button is clicked
    function closeParameters() {
      elParameters.style.visibility = "hidden";
    }

    // When the UI play button is clicked
    function togglePlay() {
      if (animationPlaying) {
        animationPlaying = false;
        elTogglePlay.innerHTML = "‚ñ∂Ô∏è";
      } else {
        animationPlaying = true;
        playStartTime = performance.now();
        elTogglePlay.innerHTML = "‚è∏";
      }
    }

    // Create an object representing a whole integration
    function newIntegration() {
      let beadMass = Number(elBeadMass.value);
      let linkLength = Number(elLinkLength.value) / 1000;
      let initialHeight = Number(elInitialHeight.value);
      let timeStep = Number(elTimeStep.value) / 1000;

      return {
        parameters: {
          beadMass: beadMass,
          linkLength: linkLength,
          initialHeight: initialHeight,
          timeStep: timeStep
        },
        timeSteps: [
          {
            beads: [
              {
                x: 0,
                y: initialHeight,
                dx: 0.1,
                dy: 0.1
              }
            ]
          }
        ]
      };
    }

    // Integrate one time step. Modifies existing integration object.
    function integrate(integration) {
      // Add a new timeStep object to integration.timeSteps array
      let params = integration.parameters;


      let timeSteps = integration.timeSteps;
      let curTimeStep = timeSteps[timeSteps.length - 1];
      let newTimeStep = {
        beads: []
      };

      // This is only temporary
      newTimeStep.beads = curTimeStep.beads.map(function(bead) {
        return {
          x: bead.x + bead.dx * params.timeStep,
          y: bead.y + bead.dy * params.timeStep,
          dx: bead.dx,
          dy: bead.dy
        };
      });

      integration.timeSteps.push(newTimeStep);
    }

    function integrateUntil(integration, endTimeStep) {
      while (integration.timeSteps.length-1 < endTimeStep) {
        integrate(integration);
      }
    }

    // Draw an integration at a particular time step onto a 2d context
    function draw(integration, timeStepIdx, ctx) {
      let initialHeight = integration.parameters.initialHeight;
      let timeStep = integration.timeSteps[timeStepIdx];
      let beads = timeStep.beads;

      // TODO: Do this properly
      ctx.clearRect(-500, -500, 1000, 1000);

      // Draw platform
      ctx.beginPath();
      ctx.rect(-platformWidth/2, initialHeight - platformHeight,
        platformWidth, platformHeight);
      //ctx.rect(-5, -5, 10, 10);
      ctx.fillStyle = platformColour;
      ctx.fill();
      ctx.closePath();

      // Draw floor
      ctx.beginPath();
      ctx.rect(0, 0, ctx.canvas.width, -platformHeight);
      ctx.fillStyle = platformColour;
      ctx.fill();
      ctx.closePath();

      // Draw links
      ctx.beginPath();
      ctx.moveTo(beads[0].x, beads[0].y);
      beads.forEach(function(bead, index) {
        if (index > 0) ctx.lineTo(bead.x, bead.y);
      });
      ctx.stroke();
      ctx.closePath();

      // Draw beads
      ctx.fillStyle = beadColour;
      beads.forEach(function(bead) {
        ctx.beginPath();
        ctx.arc(bead.x, bead.y, beadRadius, 0, Math.PI*2);
        ctx.fill();
        ctx.closePath();
      });
    }

    function onAnimationFrame(frameTime) {
      if (currentIntegration) {
        if (animationPlaying && lastFrameTime && lastFrameTime > playStartTime) {
          curAnimationTime += (frameTime - lastFrameTime)/1000;
        }
        let timeStep = currentIntegration.parameters.timeStep;
        let curTimeStep = Math.floor(curAnimationTime / timeStep);

        elTime.value = Math.floor(curAnimationTime);
        integrateUntil(currentIntegration, curTimeStep);
        draw(currentIntegration, curTimeStep, ctx);
      }

      lastFrameTime = frameTime;
      window.requestAnimationFrame(onAnimationFrame);
    }

    function onCanvasResize() {
      /* NOTE: At the moment, this only fires on window resize,
         which is most likely when the canvas will resize.
         When ResizeObserver gets implemented in browsers,
         use that instead. */

      let canvasRect = elCanvas.getBoundingClientRect();
      elCanvas.width = canvasRect.width;
      elCanvas.height = canvasRect.height;

      if (currentIntegration) {
        let initialHeight = currentIntegration.parameters.initialHeight;
        let scaleFactor = elCanvas.height/(1.5*initialHeight);
        ctx.setTransform(scaleFactor, 0, 0, -scaleFactor, 50, ctx.canvas.height);
      }
    }

    currentIntegration = newIntegration();

    window.addEventListener("resize", onCanvasResize);
    onCanvasResize();
    window.requestAnimationFrame(onAnimationFrame);

  </script>
</body>
</html>
